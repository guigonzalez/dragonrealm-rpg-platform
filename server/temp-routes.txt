// Rota para gerar automaticamente um NPC ou criatura com a OpenAI
app.post("/api/generate-npc", requireAuth, async (req, res) => {
  try {
    const { tipo = 'npc', campanha, nivel, terreno, estilo } = req.body;
    
    // Importar dinamicamente para evitar erros se a API_KEY não existir
    const { generateNPC } = await import('./openai');
    
    // Gerar o NPC com as opções fornecidas
    const generatedNPC = await generateNPC({ 
      tipo: tipo as 'npc' | 'creature',
      campanha,
      nivel,
      terreno,
      estilo 
    });
    
    // Se a imagem foi gerada, mas é uma URL externa, baixar e salvar localmente
    if (generatedNPC.imageUrl) {
      try {
        console.log("Imagem gerada pela API: ", generatedNPC.imageUrl);
        
        // Fazer download da imagem e salvá-la no sistema de arquivos
        const response = await fetch(generatedNPC.imageUrl);
        if (!response.ok) throw new Error(`Erro ao baixar imagem: ${response.status}`);
        
        const buffer = await response.arrayBuffer();
        const imageData = Buffer.from(buffer).toString('base64');
        
        // Criar caminho para salvar a imagem
        const localImagePath = saveBase64Image(`data:image/jpeg;base64,${imageData}`, generatedNPC.entityType);
        
        if (localImagePath) {
          console.log("Imagem da API salva localmente:", localImagePath);
          generatedNPC.imageUrl = localImagePath;
        }
      } catch (imageError) {
        console.error("Erro ao processar imagem do NPC gerado:", imageError);
        // Continuamos mesmo se falhar, apenas sem a imagem
      }
    }
    
    res.json(generatedNPC);
  } catch (error) {
    console.error("Erro ao gerar NPC:", error);
    res.status(500).json({ 
      message: "Falha ao gerar NPC", 
      error: error instanceof Error ? error.message : String(error) 
    });
  }
});